<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Expansor</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      background-color: #000;
      height: 100vh;
      height: 100dvh;
      display: flex;
      justify-content: center;
      align-items: center;
      touch-action: pan-x pan-y;
      overscroll-behavior: none;
    }

    .chat-container {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      height: 100dvh;
      background-color: #0b141a;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      height: 56px;
      background-color: #1f2c34;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: #e9edef;
      font-size: 16px;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      background-color: #0b141a;
      overflow-y: auto;
    }

    .message {
      background-color: #6a0dad;
      color: #e9edef;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      width: 90%;
      display: flex;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }

    .chat-input {
      background-color: #1f2c34;
      padding: 8px 12px;
      display: flex;
      align-items: flex-end;
      width: 100%;
    }

    .chat-input textarea {
      flex: 1;
      width: auto;
      min-width: 0;
      min-height: 40px;
      max-height: 120px;
      resize: none;
      border-radius: 20px;
      border: none;
      padding: 10px 16px;
      background-color: #2a3942;
      color: #e9edef;
      outline: none;
      font-size: 14px;
      overflow-y: auto;
    }

    .chat-input button {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      margin-left: 8px;
      border-radius: 50%;
      border: none;
      background-color: #00a884;
      color: #000;
      font-size: 16px;
      cursor: pointer;
    }

    @media (min-width: 481px) {
      .chat-container {
        height: 90vh;
        border-radius: 8px;
        overflow: hidden;
      }
    }

    /* Alterado para permitir 100% de largura no bloco principal */
    .block-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .message-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 6px;
        margin-bottom: 8px;
        cursor: grab;
        transition: transform 0.2s, opacity 0.2s;
        user-select: none;
        -webkit-user-select: none;
        touch-action: pan-y;
        width: 100%;
    }

    /* ESTILO PARA INDICAR QUE PODE SER ARRASTADO APÃ“S DUPLO CLIQUE */
    .message-wrapper.drag-enabled {
      outline: 2px dashed #00a884;
      background: rgba(0, 168, 132, 0.2);
      border-radius: 8px;
      padding: 2px;
    }

    .message-wrapper.dragging {
      opacity: 0.5;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transform: scale(1.02);
      z-index: 10;
    }

    .context-menu {
      position: fixed;
      background-color: #233138;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
      overflow: hidden;
      z-index: 9999;
      min-width: 160px;
    }

    .context-menu button {
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      color: #e9edef;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
    }

    .context-menu button:hover {
      background-color: #2a3942;
    }

    .chat-header {
      justify-content: space-between;
    }

    .header-menu-btn {
      background: none;
      border: none;
      color: #e9edef;
      font-size: 22px;
      cursor: pointer;
    }

    .chat-header button {
      background-color: #1f2c34;
      color: #e9edef;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: break-word;
      text-align: center;
    }

    .chat-header button:hover {
      background-color: #2a3942;
    }

    #estudarBtn.armed {
      background-color: orange;
      color: #000;
    }

    #inputMenuBtn {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      margin-left: 8px;
      border-radius: 50%;
      border: none;
      background-color: #1f2c34;
      color: #e9edef;
      font-size: 20px;
      cursor: pointer;
    }

    #inputMenuBtn.armed {
      background-color: orange;
      color: #000;
    }
    
    /* Container para as mensagens expandidas (aninhadas) */
    .nested-messages {
      padding: 0 0 10px 45px; /* Recuo para mostrar hierarquia */
      width: 100%;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
        <button id="estudarBtn">â–¶</button>
        <button id="revisado">Menu Inicial</button>
        <button class="header-menu-btn" id="headerMenuBtn">â‹®</button>
    </div>
    
    <div id="headerMenu" class="context-menu" style="display:none;">
        <button id="headerCopiar">Copiar</button>
        <button id="headerTransferir">Transferir</button>
        <button id="headerCriarPortal">Criar Portal</button>
        <button id="headerColar">Colar</button>
        <button id="headerExcluir">Excluir</button>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
        <button id="inputMenuBtn" style="margin-left:-10px;">â‹®</button>
        <textarea id="chatInput" placeholder="Mensagem" rows="1"></textarea>
        <button id="sendBtn">âž¤</button>
    </div>

    <div id="inputMenu" class="context-menu" style="display:none;">
      <button id="inputImagemBtn">Imagem</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display:none;">
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const idUrl = params.get('id');
    let idChatAtual = idUrl ? idUrl : 'no';
    
    var editarAtivado = 0;
    const input = document.getElementById('chatInput');
    const messages = document.getElementById('chatMessages');
    const sendBtn = document.getElementById('sendBtn');
    const revisadoBtn = document.getElementById('revisado');
    
    let imagemEngatilhada = null;
    const imageInput = document.getElementById('imageInput');
    const inputMenuBtn = document.getElementById('inputMenuBtn');
    const inputMenu = document.getElementById('inputMenu');
    const inputImagemBtn = document.getElementById('inputImagemBtn');

    let touchStartY = 0;
    let touchStartX = 0;
    let isDraggingTouch = false;
    let pressTimer = null;
    let menuAberto = null;

    function sendMessage() {
      const text = input.value.trim();
      if ((!text && !imagemEngatilhada) || !idChatAtual) return;

      const formData = new FormData();
      formData.append('texto', text);
      formData.append('id_chat', idChatAtual);

      if (imagemEngatilhada) {
        formData.append('imagem', imagemEngatilhada);
        imagemEngatilhada = null;
        inputMenuBtn.classList.remove('armed');
        imageInput.value = '';
      }

      fetch('adicionar_conjunto.php', { method: 'POST', body: formData })
      .then(response => response.json())
      .then(data => { if (data.success) { input.value = ''; carregarMensagens(); } });
    }

    function transformarEmChat(idMessage) {
      if (!idMessage) return;
      fetch('transformar_em_chat.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idMessage: idMessage })
      })
      .then(response => response.json())
      .then(data => { if (data.success) { input.value = ''; carregarMensagens(); } });
    }

    function editMessage() {
      const text = input.value.trim();
      if (!text || !idChatAtual) return;

      fetch('editar_conjunto.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ texto: text, editarAtivado: editarAtivado })
      })
      .then(response => response.json())
      .then(data => { if (data.success) { input.value = ''; editarAtivado = 0; carregarMensagens(); } });
    }

    function deleteMessage(idMessage) {
      if (!idMessage) return;
      fetch('excluir_conjunto.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idMessage: idMessage })
      })
      .then(response => response.json())
      .then(data => { if (data.success) { input.value = ''; carregarMensagens(); } });
    }

    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = input.scrollHeight + 'px';
    });

    sendBtn.addEventListener('click', () => {
      if (editarAtivado === 0) { sendMessage(); } else { editMessage(); }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' || e.shiftKey) return;
      e.preventDefault();
      if (editarAtivado === 0) { sendMessage(); } else { editMessage(); }
    });

    estudarBtn.addEventListener('click', () => {
      window.location.href = 'chat.html?id=' + idChatAtual;
    });

    // Reseta o estado "drag-enabled" globalmente caso o usuÃ¡rio clique fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.message-wrapper')) {
        document.querySelectorAll('.message-wrapper').forEach(w => {
          w.removeAttribute('draggable');
          w.classList.remove('drag-enabled');
        });
      }
    });

    function carregarMensagens() {
      fetch('buscar_conjuntos.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ id_conjunto: idChatAtual, id_usuario: 'idUsuario' })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) return;
        if (data.id_chat) idChatAtual = data.id_chat;
        montarLayout(data.mensagens);
      });
    }

    function toggleMensagensEmbutidas(mensagens, blockContainer) {
      let container = blockContainer.querySelector('.nested-messages');
      
      if (container) {
        container.remove();
        return;
      }

      container = document.createElement('div');
      container.className = 'nested-messages';

      if (!mensagens || mensagens.length === 0) {
        container.innerHTML = '<div style="color:#aebac1; font-size:13px;">Chat Vazio</div>';
      } else {
        mensagens.forEach(m => {
          const mDiv = document.createElement('div');
          mDiv.className = 'message';
          mDiv.style.width = '100%';
          mDiv.style.backgroundColor = '#005c4b'; 
          mDiv.style.fontSize = '15px';

          if (m.imagem) {
            const img = document.createElement('img');
            img.src = 'imagens/' + m.imagem;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            img.style.marginBottom = '6px';
            mDiv.appendChild(img);
          }

          mDiv.appendChild(document.createTextNode(m.texto));
          container.appendChild(mDiv);
        });
      }

      blockContainer.appendChild(container);
    }

    function montarLayout(mensagens) {
      messages.innerHTML = '';
      if (mensagens.length > 0) {
        mensagens.forEach(msg => {
          
          const blockContainer = document.createElement('div');
          blockContainer.className = 'block-container';

          const wrapper = document.createElement('div');
          wrapper.className = 'message-wrapper';
          // REMOVIDO o draggable="true" nativo daqui
          wrapper.dataset.id = msg.id;

          const div = document.createElement('div');
          div.className = 'message';
          div.style.flex = '33';

          if (msg.imagem) {
            const img = document.createElement('img');
            img.src = 'imagens/' + msg.imagem;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            img.style.marginBottom = '6px';
            div.appendChild(img);
          }

          div.appendChild(document.createTextNode(msg.texto));

          // BOTÃƒO LATERAL (DINÃ‚MICO)
          const btnAcao = document.createElement('button');
          btnAcao.className = 'message';
          btnAcao.style.flex = '1';
          btnAcao.style.justifyContent = 'center';
          btnAcao.style.alignItems = 'center';
          btnAcao.style.cursor = 'pointer';

          if (msg.tipo === 1) {
             // Ã‰ CHAT
             btnAcao.textContent = 'â–¶';
             btnAcao.style.backgroundColor = 'green';
             btnAcao.onclick = (e) => {
                 e.stopPropagation();
                 toggleMensagensEmbutidas(msg.mensagens, blockContainer);
             };
          } else if (msg.tipo === 2) {
             // Ã‰ PORTAL
             btnAcao.innerHTML = 'ðŸšª<br><span style="font-size:11px; margin-top:2px; display:block;">' + msg.qtd_filhos + '</span>';
             btnAcao.style.backgroundColor = '#8e44ad'; // Roxo
             btnAcao.style.flexDirection = 'column';
             btnAcao.onclick = (e) => {
                 e.stopPropagation();
                 window.location.href = 'index.html?id=' + (msg.id_conjunto_portal || msg.id);
             };
          } else {
             // Ã‰ CONJUNTO
             btnAcao.textContent = msg.qtd_filhos;
             btnAcao.style.backgroundColor = '#1f2c34'; // Cor neutra
             btnAcao.onclick = (e) => {
                 e.stopPropagation();
                 window.location.href = 'index.html?id=' + msg.id;
             };
          }

          const cancelPress = () => { clearTimeout(pressTimer); };

          // LÃ³gica de Ativar Arraste via duplo clique/toque
          let lastTap = 0;
          const ativarArraste = () => {
            // Remove de outros elementos para focar neste
            document.querySelectorAll('.message-wrapper').forEach(w => {
              w.removeAttribute('draggable');
              w.classList.remove('drag-enabled');
            });
            wrapper.setAttribute('draggable', 'true');
            wrapper.classList.add('drag-enabled');
            if (navigator.vibrate) navigator.vibrate(50);
          };

          wrapper.addEventListener('dblclick', ativarArraste);

          // --- LOGICA TOUCH (SAFARI MOBILE) ---
          wrapper.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            touchStartY = touch.clientY;
            touchStartX = touch.clientX;
            isDraggingTouch = false;

            pressTimer = setTimeout(() => {
              if (!isDraggingTouch) { abrirMenu(touch.clientX, touch.clientY, msg); }
            }, 1500);
          }, { passive: true });

          wrapper.addEventListener('touchmove', (e) => {
            // BLOQUEIO: SÃ³ processa a lÃ³gica de arrastar se foi duplo clicado/tocado
            if (!wrapper.classList.contains('drag-enabled')) return;

            const touch = e.touches[0];
            const moveY = Math.abs(touch.clientY - touchStartY);
            const moveX = Math.abs(touch.clientX - touchStartX);

            if (moveY > 10 || moveX > 10) {
              isDraggingTouch = true;
              cancelPress();
              
              if (!wrapper.classList.contains('dragging')) {
                wrapper.classList.add('dragging');
              }
              if (e.cancelable) e.preventDefault();

              const afterElement = getDragAfterElement(messages, touch.clientY);
              if (afterElement == null) {
                messages.appendChild(blockContainer);
              } else {
                messages.insertBefore(blockContainer, afterElement);
              }
            }
          }, { passive: false });

          wrapper.addEventListener('touchend', (e) => {
            cancelPress();
            
            // Detecta duplo-toque (gap < 300ms)
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0 && !isDraggingTouch) {
              ativarArraste();
              if (e.cancelable) e.preventDefault();
            }
            lastTap = currentTime;

            if (wrapper.classList.contains('dragging')) {
              wrapper.classList.remove('dragging');
              wrapper.classList.remove('drag-enabled');
              wrapper.removeAttribute('draggable');
              salvarNovaOrdem();
            }
          });

          // --- LOGICA DESKTOP (DRAG & DROP) ---
          div.addEventListener('mousedown', (e) => {
            pressTimer = setTimeout(() => { abrirMenu(e.clientX, e.clientY, msg); }, 1500);
          });
          div.addEventListener('mouseup', cancelPress);
          div.addEventListener('mouseleave', cancelPress);

          wrapper.addEventListener('dragstart', () => {
            cancelPress();
            wrapper.classList.add('dragging');
          });

          wrapper.addEventListener('dragend', () => {
            wrapper.classList.remove('dragging');
            wrapper.classList.remove('drag-enabled');
            wrapper.removeAttribute('draggable');
            salvarNovaOrdem();
          });

          wrapper.appendChild(btnAcao);
          wrapper.appendChild(div);
          
          blockContainer.appendChild(wrapper);
          messages.appendChild(blockContainer);
        });
      }
      messages.scrollTop = messages.scrollHeight;
    }

    messages.addEventListener('dragover', e => {
      e.preventDefault();
      const afterElement = getDragAfterElement(messages, e.clientY);
      const draggableWrapper = document.querySelector('.dragging');
      if (draggableWrapper && !isDraggingTouch) { 
        const draggableBlock = draggableWrapper.parentElement;
        if (afterElement == null) {
          messages.appendChild(draggableBlock);
        } else {
          messages.insertBefore(draggableBlock, afterElement);
        }
      }
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.block-container:not(:has(.dragging))')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function salvarNovaOrdem() {
      const ids = [...messages.querySelectorAll('.message-wrapper')].map(el => el.dataset.id);
      fetch('reordenar_conjuntos.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids, id_pai: idChatAtual })
      });
    }

    window.addEventListener('load', carregarMensagens);

    function fecharMenu() {
      if (menuAberto) { menuAberto.remove(); menuAberto = null; }
    }

    document.addEventListener('mousedown', fecharMenu);
    document.addEventListener('scroll', fecharMenu);

    function abrirMenu(x, y, msg) {
      fecharMenu();
      const menu = document.createElement('div');
      menu.className = 'context-menu';
      menu.style.top = y + 'px';
      menu.style.left = x + 'px';

      menu.addEventListener('mousedown', e => e.stopPropagation());
      menu.addEventListener('click', e => e.stopPropagation());
      
      const virarChat = document.createElement('button');
      virarChat.textContent = 'Virar chat';
      virarChat.onclick = () => { transformarEmChat(msg.id); fecharMenu(); };

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.onclick = () => {
        editarAtivado = msg.id;
        input.value = msg.texto;
        input.focus();
        fecharMenu();
      };

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'Excluir';
      btnExcluir.onclick = () => { deleteMessage(msg.id); fecharMenu(); };

      menu.appendChild(virarChat);
      menu.appendChild(btnEditar);
      menu.appendChild(btnExcluir);
      document.body.appendChild(menu);
      menuAberto = menu;
    }

    const headerBtn = document.getElementById('headerMenuBtn');
    const headerMenu = document.getElementById('headerMenu');

    headerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      headerMenu.style.display = 'block';
      const rect = headerBtn.getBoundingClientRect();
      const menuWidth = headerMenu.offsetWidth;
      headerMenu.style.top = rect.bottom + 'px';
      headerMenu.style.left = (rect.left - menuWidth) + 'px';
    });

    headerMenu.addEventListener('click', (e) => { e.stopPropagation(); });
    document.addEventListener('click', () => { headerMenu.style.display = 'none'; });
    
    document.getElementById('headerExcluir').addEventListener('click', () => { headerMenu.style.display = 'none'; });
    document.getElementById('headerCopiar').addEventListener('click', () => { copiarConjunto(idChatAtual); headerMenu.style.display = 'none'; });
    document.getElementById('headerTransferir').addEventListener('click', () => { transferirConjunto(); headerMenu.style.display = 'none'; });
    document.getElementById('headerCriarPortal').addEventListener('click', () => { criarPortal(); headerMenu.style.display = 'none'; });
    document.getElementById('headerColar').addEventListener('click', () => { colarConjunto(); headerMenu.style.display = 'none'; });

    revisadoBtn.addEventListener('click', () => { concluirRevisao(); });

    function concluirRevisao() {
      if (!idChatAtual) return;
      fetch('concluir_revisao.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_chat: idChatAtual })
      })
      .then(response => response.json())
      .then(data => { if (data.success) { carregarMensagens(); } });
    }

    function transferirConjunto() {
      if (!idChatAtual) return;
      fetch('transferir_conjunto.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id_conjunto: idChatAtual }) })
      .then(response => response.json())
      .then(data => { if (data.success) { carregarMensagens(); } });
    }

    function criarPortal() {
      if (!idChatAtual) return;
      fetch('criar_portal.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id_conjunto: idChatAtual }) })
      .then(response => response.json())
      .then(data => { 
          if (data.success) { 
              carregarMensagens(); 
          } else {
              alert('Erro: ' + data.error);
          }
      });
    }

    function copiarConjunto(idConjunto) {
      if (!idConjunto) return;
      fetch('copiar_conjunto.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id_conjunto: idConjunto }) })
      .then(response => response.json())
      .then(data => { if (data.success) { carregarMensagens(); } });
    }

    function colarConjunto() {
      if (!idChatAtual) return;
      fetch('colar_conjunto.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id_conjunto: idChatAtual }) })
      .then(response => response.json())
      .then(data => { if (data.success) { carregarMensagens(); } });
    }

    inputMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (imagemEngatilhada) {
        imagemEngatilhada = null;
        inputMenuBtn.classList.remove('armed');
        imageInput.value = '';
        inputMenu.style.display = 'none';
        return;
      }
      inputMenu.style.display = 'block';
      const rect = inputMenuBtn.getBoundingClientRect();
      inputMenu.style.top = rect.top - inputMenu.offsetHeight + 'px';
      inputMenu.style.left = rect.left + 'px';
    });

    document.addEventListener('click', () => { inputMenu.style.display = 'none'; });
    inputImagemBtn.addEventListener('click', () => { imageInput.click(); inputMenu.style.display = 'none'; });

    imageInput.addEventListener('change', () => {
      if (imageInput.files.length > 0) {
        imagemEngatilhada = imageInput.files[0];
        inputMenuBtn.classList.add('armed');
      }
    });

    document.addEventListener('touchstart', function (event) {
      if (event.touches.length > 1) { event.preventDefault(); }
    }, { passive: false });

    let lastTouchEndGlobal = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEndGlobal <= 300 && !event.target.closest('.message-wrapper')) { event.preventDefault(); }
      lastTouchEndGlobal = now;
    }, false);
  </script>
</body>
</html>
